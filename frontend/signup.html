<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architect Johan ‚Äî Create Secure Account</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/responsive.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            font-family: 'Courier New', 'Consolas', monospace;
        }

        .login-page-body {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(135deg, #02040A 0%, #0A0F2D 50%, #02040A 100%);
        }

        .login-content {
            width: 100%;
            max-width: 480px;
            margin: 40px auto;
            position: relative;
            z-index: 10;
        }

        .login-card {
            background: rgba(2, 4, 10, 0.95);
            backdrop-filter: blur(15px);
            border: 2px solid #00FFB3;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 0 50px rgba(0, 255, 179, 0.4),
                        inset 0 0 50px rgba(0, 255, 179, 0.05);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 255, 179, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 179, 0.2);
        }

        .auth-switch a {
            color: #2EC6FF;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .auth-switch a:hover {
            color: #00FFB3;
            text-decoration: underline;
        }

        .password-strength {
            margin-top: 8px;
        }

        .strength-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .strength-fill.weak { width: 20%; background: #FF004C; }
        .strength-fill.fair { width: 40%; background: #FF8A00; }
        .strength-fill.good { width: 60%; background: #FFD600; }
        .strength-fill.strong { width: 80%; background: #8CE300; }
        .strength-fill.very-strong { width: 100%; background: #00FFB3; }

        .password-requirements {
            font-size: 11px;
            color: #2EC6FF;
            line-height: 1.4;
            margin-top: 5px;
        }

        .mobile-input {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .country-code {
            padding: 16px 12px;
            background: rgba(0, 255, 179, 0.1);
            border: 2px solid rgba(0, 255, 179, 0.3);
            border-right: none;
            border-radius: 10px 0 0 10px;
            color: #00FFB3;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            min-width: 60px;
            text-align: center;
        }

        .mobile-input input {
            border-radius: 0 10px 10px 0;
            border-left: none;
            width: 100%;
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        /* Loading state for button */
        .login-btn.loading {
            position: relative;
            overflow: hidden;
        }

        .login-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Input focus states */
        .input-wrapper.focused {
            box-shadow: 0 0 10px rgba(0, 255, 179, 0.3);
        }

        /* Custom scrollbar for the card */
        .login-card::-webkit-scrollbar {
            width: 6px;
        }

        .login-card::-webkit-scrollbar-track {
            background: rgba(0, 255, 179, 0.1);
            border-radius: 3px;
        }

        .login-card::-webkit-scrollbar-thumb {
            background: #00FFB3;
            border-radius: 3px;
        }

        .login-card::-webkit-scrollbar-thumb:hover {
            background: #2EC6FF;
        }

        /* Logo styles */
        .logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border: 2px solid #00FFB3;
            border-radius: 50%;
            background: rgba(0, 255, 179, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 179, 0.5);
            animation: logoSpin 20s linear infinite;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .logo::before {
            content: 'AJ';
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            color: #00FFB3;
            display: none;
        }

        .logo:not(:has(img))::before {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes logoSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Security info styles */
        .security-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 255, 179, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 179, 0.2);
        }

        .security-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #2EC6FF;
        }

        .security-icon {
            font-size: 14px;
        }

        .footer-text {
            text-align: center;
            font-size: 10px;
            color: #00FFB3;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 255, 179, 0.05);
            border-radius: 5px;
            border: 1px solid rgba(0, 255, 179, 0.1);
        }

        /* Error and success messages */
        .error-message {
            background: rgba(255, 0, 76, 0.1);
            border: 1px solid rgba(255, 0, 76, 0.3);
            color: #FF004C;
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
            text-align: center;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: rgba(0, 255, 179, 0.1);
            border: 1px solid rgba(0, 255, 179, 0.3);
            color: #00FFB3;
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
            text-align: center;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .success-message.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Shake animation for errors */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Responsive adjustments */
        @media (max-height: 800px) {
            .login-content {
                margin: 20px auto;
            }
            
            .login-card {
                padding: 30px 25px;
                max-height: 85vh;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
        }

        @media (max-height: 700px) {
            .login-card {
                padding: 25px 20px;
                max-height: 80vh;
            }
            
            .login-header {
                margin-bottom: 20px;
            }
            
            .login-header h1 {
                font-size: 24px;
            }
            
            .login-header p {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .login-page-body {
                padding: 10px;
                align-items: flex-start;
            }
            
            .login-content {
                margin: 20px auto;
                max-width: 95%;
            }
            
            .login-card {
                padding: 25px 20px;
                border-width: 1px;
            }
            
            .country-code {
                padding: 12px 8px;
                font-size: 14px;
                min-width: 50px;
            }
            
            input {
                padding: 14px 16px;
                font-size: 14px;
            }
            
            .login-btn {
                padding: 16px;
                font-size: 14px;
            }

            .password-requirements {
                font-size: 10px;
                line-height: 1.3;
            }
        }

        @media (max-width: 360px) {
            .login-card {
                padding: 20px 15px;
            }
            
            .login-header h1 {
                font-size: 22px;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
        }

.otp-btn {
    background: rgba(46, 198, 255, 0.2);
    border: 1px solid #2EC6FF;
    color: #2EC6FF;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.otp-btn:hover {
    background: rgba(46, 198, 255, 0.3);
}

.otp-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}




    /* Add these styles to your existing CSS */

    .otp-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 8px;
    }

    .otp-btn {
        background: rgba(0, 255, 179, 0.1);
        border: 2px solid #00FFB3;
        color: #00FFB3;
        padding: 12px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .otp-btn:hover {
        background: rgba(0, 255, 179, 0.2);
        box-shadow: 0 0 15px rgba(0, 255, 179, 0.4);
        transform: translateY(-2px);
    }

    .otp-btn:active {
        transform: translateY(0);
    }

    .otp-btn:disabled {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(0, 255, 179, 0.3);
        color: rgba(0, 255, 179, 0.5);
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    .otp-btn.verified {
        background: rgba(0, 255, 179, 0.3);
        border-color: #00FFB3;
        color: #02040A;
        font-weight: bold;
    }

    .otp-input {
        background: rgba(2, 4, 10, 0.8);
        border: 2px solid rgba(0, 255, 179, 0.3);
        border-radius: 10px;
        color: #00FFB3;
        padding: 12px 16px;
        font-size: 16px;
        font-family: 'Courier New', monospace;
        text-align: center;
        transition: all 0.3s ease;
    }

    .otp-input:focus {
        outline: none;
        border-color: #00FFB3;
        box-shadow: 0 0 10px rgba(0, 255, 179, 0.3);
    }

    .otp-input::placeholder {
        color: rgba(0, 255, 179, 0.5);
    }

    .otp-status {
        font-size: 12px;
        color: #2EC6FF;
        text-align: center;
        margin-top: 5px;
        min-height: 18px;
        font-family: 'Courier New', monospace;
    }

    .otp-status.success {
        color: #00FFB3;
    }

    .otp-status.error {
        color: #FF004C;
    }

    .otp-status.warning {
        color: #FF8A00;
    }

    .otp-row {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .otp-row .otp-btn {
        flex: 1;
    }

    /* Responsive adjustments for OTP section */
    @media (max-width: 480px) {
        .otp-btn {
            padding: 10px 14px;
            font-size: 13px;
        }

        .otp-input {
            padding: 10px 14px;
            font-size: 14px;
        }

        .otp-status {
            font-size: 11px;
        }

        .otp-row {
            flex-direction: column;
            gap: 8px;
        }
    }

    @media (max-width: 360px) {
        .otp-btn {
            padding: 8px 12px;
            font-size: 12px;
        }

        .otp-input {
            padding: 8px 12px;
            font-size: 13px;
        }
    }
</style>
        
    </style>
</head>
<body class="login-page-body">
    <canvas id="matrix-canvas" class="login-background"></canvas>

    <div class="login-content">
        <div class="login-card" id="signup-card">
            <div class="login-header">
                <div class="logo">
                    <img src="assets/images/cropped_circle_image.png" alt="Architect Johan Logo" 
                         onerror="this.style.display='none'; this.parentElement.innerHTML='AJ';">
                </div>
                <h1>Create Secure Account</h1>
                <p>Join Architect Johan Community</p>
            </div>

            <form id="signup-form">
                <input type="hidden" id="csrf_token" name="csrf_token">
                
                <div class="form-group">
                    <label for="username">Username</label>
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            placeholder="Choose a username (3-30 characters)"
                            autocomplete="username"
                            required
                            minlength="3"
                            maxlength="30"
                            pattern="[a-zA-Z0-9_]+"
                            title="Only letters, numbers, and underscores allowed"
                        >
                    </div>
                </div>

                <div class="form-group">
                    <label for="full_name">Full Name</label>
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="full_name" 
                            name="full_name" 
                            placeholder="Enter your full name"
                            autocomplete="name"
                            required
                            minlength="2"
                            maxlength="100"
                        >
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <div class="input-wrapper">
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            placeholder="Enter your email"
                            autocomplete="email"
                            required
                            maxlength="100"
                        >
                    </div>
                </div>

               <div class="form-group">
    <label for="mobile_no">Mobile Number</label>
    <div class="mobile-input">
        <div class="country-code">+91</div>
        <input 
            type="tel" 
            id="mobile_no" 
            name="mobile_no" 
            placeholder="Enter 10-digit mobile number"
            autocomplete="tel"
            required
            maxlength="10"
            pattern="[0-9]{10}"
            title="Please enter a valid 10-digit mobile number"
        >
    </div>
    
    <div class="otp-section">
        <div class="otp-row">
            <button type="button" id="send-otp-btn" class="otp-btn" onclick="sendOTP()">
                Send OTP
            </button>
        </div>
        
        <input 
            type="text" 
            id="otp" 
            name="otp" 
            placeholder="Enter 6-digit OTP"
            maxlength="6"
            class="otp-input"
            style="display: none;"
        >
        
        <div class="otp-row">
            <button type="button" id="verify-otp-btn" class="otp-btn" onclick="verifyOTP()" style="display: none;">
                Verify OTP
            </button>
        </div>
        
        <div id="otp-status" class="otp-status"></div>
    </div>
</div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrapper">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            placeholder="Create a strong password"
                            autocomplete="new-password"
                            required
                            minlength="8"
                            maxlength="100"
                        >
                    </div>
                    <div class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strength-fill"></div>
                        </div>
                        <div class="password-requirements" id="password-requirements">
                            ‚Ä¢ 8+ characters ‚Ä¢ Uppercase ‚Ä¢ Lowercase ‚Ä¢ Number ‚Ä¢ Special character
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm Password</label>
                    <div class="input-wrapper">
                        <input 
                            type="password" 
                            id="confirm_password" 
                            name="confirm_password" 
                            placeholder="Confirm your password"
                            autocomplete="new-password"
                            required
                            minlength="8"
                            maxlength="100"
                        >
                    </div>
                </div>

                <button type="submit" class="login-btn" id="signup-btn">
                    <span class="btn-text">Create Secure Account</span>
                </button>

                <div class="error-message" id="error-message">
                    Registration Failed
                </div>

                <div class="success-message" id="success-message">
                    Account Created Successfully! Redirecting to login...
                </div>
            </form>

            <div class="auth-switch">
                Already have an account? <a href="index.html">Sign In</a>
            </div>

            <div class="security-info">
                <div class="security-item">
                    <span class="security-icon">üîí</span>
                    <span>End-to-End Encryption</span>
                </div>
                <div class="security-item">
                    <span class="security-icon">üõ°Ô∏è</span>
                    <span>CSRF Protection Active</span>
                </div>
                <div class="security-item">
                    <span class="security-icon">‚ö°</span>
                    <span>Secure Password Hashing</span>
                </div>
                <div class="security-item">
                    <span class="security-icon">üìß</span>
                    <span>Email & Username Validation</span>
                </div>
            </div>

            <div class="footer-text">
                ENCRYPTED CONNECTION ESTABLISHED | RATE LIMITING ACTIVE | SECURE REGISTRATION
            </div>
        </div>
    </div>
<!-- Enhanced Debug Section -->
<div style="text-align: center; margin: 20px 0; padding: 15px; background: rgba(255, 138, 0, 0.1); border: 1px solid #FF8A00; border-radius: 10px;">
    <h4 style="color: #FF8A00; margin-bottom: 10px;">üîß Debug Tools</h4>
    <button onclick="debugMSG91Config()" class="otp-btn" style="background: #FF8A00; margin: 5px;">
        Debug MSG91 Config
    </button>
    <button onclick="forceSendOTP()" class="otp-btn" style="background: #00FFB3; margin: 5px;">
        Force Send OTP
    </button>
    <button onclick="checkServerLogs()" class="otp-btn" style="background: #2EC6FF; margin: 5px;">
        Check Server Status
    </button>
</div>
    <script src="js/matrix.js"></script>
 <script>
    // API Base URL
    const API_BASE_URL = 'https://architect-johan-secure.onrender.com';

    // OTP Management
    let otpCountdown = 0;
    let otpTimer = null;

    function startOTPTimer() {
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const otpStatus = document.getElementById('otp-status');
        
        otpCountdown = 60;
        sendOtpBtn.disabled = true;
        
        otpTimer = setInterval(() => {
            otpCountdown--;
            sendOtpBtn.textContent = `Resend OTP (${otpCountdown}s)`;
            otpStatus.innerHTML = `<span style="color: #FF8A00">OTP sent! Valid for 10 minutes. Resend in ${otpCountdown}s</span>`;
            
            if (otpCountdown <= 0) {
                clearInterval(otpTimer);
                sendOtpBtn.disabled = false;
                sendOtpBtn.textContent = 'Resend OTP';
                otpStatus.innerHTML = '<span style="color: #FF004C">OTP expired. Click to resend.</span>';
            }
        }, 1000);
    }

   async function sendOTP() {
    const mobileInput = document.getElementById('mobile_no');
    const mobileNo = mobileInput.value;
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const otpInput = document.getElementById('otp');
    const verifyOtpBtn = document.getElementById('verify-otp-btn');
    const otpStatus = document.getElementById('otp-status');

    // Validate mobile number first
    if (!mobileNo || mobileNo.length !== 10 || !/^[6-9]\d{9}$/.test(mobileNo)) {
        showError('Please enter a valid 10-digit Indian mobile number starting with 6-9');
        mobileInput.focus();
        return;
    }

    // Update UI for loading
    sendOtpBtn.disabled = true;
    sendOtpBtn.textContent = 'Sending OTP...';
    otpStatus.innerHTML = '<span style="color: #2EC6FF">Sending OTP via SMS...</span>';

    try {
        const response = await fetch(`${API_BASE_URL}/api/send-otp`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mobile_no: '+91' + mobileNo
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Show OTP input field
            otpInput.style.display = 'block';
            verifyOtpBtn.style.display = 'block';
            otpInput.value = ''; // Clear previous OTP
            
            // Start countdown timer
            startOTPTimer();
            
            // Check if OTP is provided in response (SMS failed case)
            if (data.otp) {
                otpStatus.innerHTML = `<span style="color: #FF8A00">üì± SMS service issue. Use OTP: <strong>${data.otp}</strong></span>`;
                console.log(`üì± Test OTP (SMS failed): ${data.otp}`);
                showSuccess('OTP generated! Check the red message below for your OTP.');
            } else {
                otpStatus.innerHTML = '<span style="color: #00FFB3">‚úÖ OTP sent via SMS! Check your phone.</span>';
                showSuccess('OTP sent successfully! Check your mobile phone.');
            }
            
        } else {
            showError(data.error || 'Failed to send OTP');
            sendOtpBtn.disabled = false;
            sendOtpBtn.textContent = 'Send OTP';
            otpStatus.innerHTML = '<span style="color: #FF004C">Failed to send OTP</span>';
        }
    } catch (error) {
        console.error('OTP sending error:', error);
        showError('Network error. Please check your connection and try again.');
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Send OTP';
        otpStatus.innerHTML = '<span style="color: #FF004C">Network error</span>';
    }
}

    async function verifyOTP() {
        const mobileNo = document.getElementById('mobile_no').value;
        const otpInput = document.getElementById('otp');
        const otpValue = otpInput.value;
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const otpStatus = document.getElementById('otp-status');

        if (!otpValue || otpValue.length !== 6 || !/^\d+$/.test(otpValue)) {
            showError('Please enter a valid 6-digit OTP');
            otpInput.focus();
            return;
        }

        // Update UI for loading
        verifyOtpBtn.disabled = true;
        verifyOtpBtn.textContent = 'Verifying...';
        otpStatus.innerHTML = '<span style="color: #2EC6FF">Verifying OTP...</span>';

        try {
            const response = await fetch(`${API_BASE_URL}/api/verify-otp`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    mobile_no: '+91' + mobileNo,
                    otp: otpValue
                })
            });

            const data = await response.json();

            if (response.ok) {
                // OTP verified successfully
                otpStatus.innerHTML = '<span style="color: #00FFB3">‚úÖ Mobile number verified!</span>';
                verifyOtpBtn.textContent = 'Verified';
                verifyOtpBtn.disabled = true;
                verifyOtpBtn.style.background = '#00FFB3';
                verifyOtpBtn.style.color = '#02040A';
                
                // Store mobile verification status
                sessionStorage.setItem('mobile_verified', 'true');
                sessionStorage.setItem('verified_mobile', '+91' + mobileNo);
                sessionStorage.setItem('verified_at', new Date().toISOString());
                
                showSuccess('Mobile number verified successfully!');
                
                // Clear OTP timer
                if (otpTimer) {
                    clearInterval(otpTimer);
                }
            } else {
                showError(data.error || 'Invalid OTP');
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.textContent = 'Verify OTP';
                
                if (data.attempts_remaining) {
                    otpStatus.innerHTML = `<span style="color: #FF004C">${data.error}</span>`;
                } else {
                    otpStatus.innerHTML = '<span style="color: #FF004C">Invalid OTP</span>';
                }
            }
        } catch (error) {
            console.error('OTP verification error:', error);
            showError('Network error during OTP verification');
            verifyOtpBtn.disabled = false;
            verifyOtpBtn.textContent = 'Verify OTP';
            otpStatus.innerHTML = '<span style="color: #FF004C">Network error</span>';
        }
    }

    // Check if mobile is already verified
    function isMobileVerified() {
        return sessionStorage.getItem('mobile_verified') === 'true';
    }

    // Check social media verification
    function checkSocialVerification() {
        return sessionStorage.getItem('social_verification') === 'completed';
    }

    // Reset OTP verification when mobile number changes
    function resetOTPVerification() {
        const otpInput = document.getElementById('otp');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const otpStatus = document.getElementById('otp-status');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        
        if (otpTimer) {
            clearInterval(otpTimer);
        }
        
        otpInput.style.display = 'none';
        verifyOtpBtn.style.display = 'none';
        verifyOtpBtn.disabled = false;
        verifyOtpBtn.textContent = 'Verify OTP';
        verifyOtpBtn.style.background = '';
        verifyOtpBtn.style.color = '';
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Send OTP';
        otpStatus.innerHTML = '';
        
        sessionStorage.removeItem('mobile_verified');
        sessionStorage.removeItem('verified_mobile');
    }

    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>?`~]/.test(password)
        };

        Object.values(requirements).forEach(req => {
            if (req) strength++;
        });

        return { strength, requirements };
    }

    // Update password strength indicator
    function updatePasswordStrength(password) {
        const strengthFill = document.getElementById('strength-fill');
        const requirements = document.getElementById('password-requirements');
        
        if (!password) {
            strengthFill.style.width = '0%';
            strengthFill.className = 'strength-fill';
            requirements.innerHTML = '‚Ä¢ 8+ characters ‚Ä¢ Uppercase ‚Ä¢ Lowercase ‚Ä¢ Number ‚Ä¢ Special character';
            return;
        }

        const { strength, requirements: reqs } = checkPasswordStrength(password);
        
        // Update strength bar
        switch(strength) {
            case 0:
            case 1:
                strengthFill.style.width = '20%';
                strengthFill.className = 'strength-fill weak';
                break;
            case 2:
                strengthFill.style.width = '40%';
                strengthFill.className = 'strength-fill fair';
                break;
            case 3:
                strengthFill.style.width = '60%';
                strengthFill.className = 'strength-fill good';
                break;
            case 4:
                strengthFill.style.width = '80%';
                strengthFill.className = 'strength-fill strong';
                break;
            case 5:
                strengthFill.style.width = '100%';
                strengthFill.className = 'strength-fill very-strong';
                break;
        }

        // Update requirements text
        let reqText = '';
        if (!reqs.length) reqText += '‚Ä¢ <span style="color: #FF004C">8+ characters</span> ';
        else reqText += '‚Ä¢ <span style="color: #00FFB3">8+ characters</span> ';

        if (!reqs.uppercase) reqText += '‚Ä¢ <span style="color: #FF004C">Uppercase</span> ';
        else reqText += '‚Ä¢ <span style="color: #00FFB3">Uppercase</span> ';

        if (!reqs.lowercase) reqText += '‚Ä¢ <span style="color: #FF004C">Lowercase</span> ';
        else reqText += '‚Ä¢ <span style="color: #00FFB3">Lowercase</span> ';

        if (!reqs.number) reqText += '‚Ä¢ <span style="color: #FF004C">Number</span> ';
        else reqText += '‚Ä¢ <span style="color: #00FFB3">Number</span> ';

        if (!reqs.special) reqText += '‚Ä¢ <span style="color: #FF004C">Special character</span>';
        else reqText += '‚Ä¢ <span style="color: #00FFB3">Special character</span>';

        requirements.innerHTML = reqText;
    }

    // Input sanitization function
    function sanitizeInput(input) {
        return input.replace(/[<>"'`]/g, '').trim();
    }

    // Gmail validation function
    function validateGmail(email) {
        const gmailRegex = /^[a-zA-Z0-9.]+@gmail\.com$/;
        return gmailRegex.test(email);
    }

    // Disposable email domain check
    function isDisposableEmail(email) {
        const disposableDomains = [
            'tempmail.com', 'guerrillamail.com', 'mailinator.com',
            '10minutemail.com', 'throwawaymail.com', 'fakeinbox.com',
            'yopmail.com', 'trashmail.com', 'temp-mail.org',
            'sharklasers.com', 'guerrillamail.biz', 'grr.la',
            'guerrillamail.org', 'guerrillamail.net', 'guerrillamail.de',
            'spam4.me', 'fake-mail.com', 'dispostable.com',
            'mailnesia.com', 'getairmail.com', 'maildrop.cc'
        ];
        
        const domain = email.split('@')[1].toLowerCase();
        return disposableDomains.includes(domain);
    }

    // Enhanced email validation
    function validateEmailEnhanced(email) {
        if (!email) {
            return {
                isValid: false,
                error: 'Email is required'
            };
        }

        if (!validateGmail(email)) {
            return {
                isValid: false,
                error: 'Only Gmail accounts are allowed. Please use a valid Gmail address ending with @gmail.com'
            };
        }
        
        if (isDisposableEmail(email)) {
            return {
                isValid: false,
                error: 'Temporary/disposable email addresses are not allowed. Please use your personal Gmail account.'
            };
        }
        
        return { isValid: true };
    }

    // Validate email format
    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Validate username format
    function validateUsername(username) {
        const usernameRegex = /^[a-zA-Z0-9_]{3,30}$/;
        return usernameRegex.test(username);
    }

    // Show error message with animation
    function showError(message) {
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const card = document.getElementById('signup-card');
        
        errorMessage.textContent = message;
        errorMessage.classList.add('show');
        successMessage.classList.remove('show');
        
        card.classList.add('shake');
        setTimeout(() => card.classList.remove('shake'), 500);
        
        // Auto-hide error after 5 seconds
        setTimeout(() => {
            errorMessage.classList.remove('show');
        }, 5000);
    }

    // Show success message
    function showSuccess(message) {
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        
        successMessage.textContent = message;
        successMessage.classList.add('show');
        errorMessage.classList.remove('show');
    }

    // Validate form data
    function validateFormData(formData) {
        // Check required fields
        if (!formData.username || !formData.full_name || !formData.email || !formData.mobile_no || !formData.password) {
            return { isValid: false, error: 'Please fill in all required fields' };
        }

        // Validate username
        if (formData.username.length < 3 || formData.username.length > 30) {
            return { isValid: false, error: 'Username must be between 3 and 30 characters long', field: 'username' };
        }

        if (!validateUsername(formData.username)) {
            return { isValid: false, error: 'Username can only contain letters, numbers, and underscores', field: 'username' };
        }

        // Validate full name
        if (formData.full_name.length < 2 || formData.full_name.length > 100) {
            return { isValid: false, error: 'Full name must be between 2 and 100 characters long', field: 'full_name' };
        }

        // Enhanced Gmail validation
        const emailValidation = validateEmailEnhanced(formData.email);
        if (!emailValidation.isValid) {
            return { isValid: false, error: emailValidation.error, field: 'email' };
        }

        // Validate mobile number
        const mobileDigits = formData.mobile_no.replace('+91', '');
        if (mobileDigits.length !== 10 || !/^[6-9]\d{9}$/.test(mobileDigits)) {
            return { isValid: false, error: 'Please enter a valid 10-digit Indian mobile number starting with 6-9', field: 'mobile_no' };
        }

        // Check mobile verification
        if (!isMobileVerified()) {
            return { isValid: false, error: 'Please verify your mobile number with OTP before signing up', field: 'mobile_no' };
        }

        // Check if mobile number matches verified number
        const verifiedMobile = sessionStorage.getItem('verified_mobile');
        if (verifiedMobile !== formData.mobile_no) {
            return { isValid: false, error: 'Mobile number does not match verified number. Please verify the correct number.', field: 'mobile_no' };
        }

        // Validate password strength
        const passwordStrength = checkPasswordStrength(formData.password);
        if (passwordStrength.strength < 3) {
            return { isValid: false, error: 'Password is too weak. Please include uppercase letters, lowercase letters, numbers, and special characters', field: 'password' };
        }

        // Check password confirmation
        if (formData.password !== formData.confirm_password) {
            return { isValid: false, error: 'Passwords do not match', field: 'confirm_password' };
        }

        return { isValid: true };
    }

    // Main signup functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user completed social verification
        if (!checkSocialVerification()) {
            showError('Please complete social media verification first. Redirecting to gateway...');
            setTimeout(() => {
                window.location.href = 'gateway.html';
            }, 3000);
            return;
        }

        const signupForm = document.getElementById('signup-form');
        const signupBtn = document.getElementById('signup-btn');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const csrfTokenInput = document.getElementById('csrf_token');

        // Get CSRF token
        fetch(`${API_BASE_URL}/api/csrf-token`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to get CSRF token');
                }
                return response.json();
            })
            .then(data => {
                if (data.csrf_token) {
                    csrfTokenInput.value = data.csrf_token;
                }
            })
            .catch(error => {
                console.error('Error fetching CSRF token:', error);
                showError('Security token initialization failed. Please refresh the page.');
            });

        // Password strength real-time feedback
        const passwordInput = document.getElementById('password');
        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                updatePasswordStrength(this.value);
            });
        }

        // Password confirmation validation
        const confirmPasswordInput = document.getElementById('confirm_password');
        if (confirmPasswordInput) {
            confirmPasswordInput.addEventListener('input', function() {
                const password = document.getElementById('password').value;
                if (this.value && password !== this.value) {
                    this.style.borderColor = '#FF004C';
                    this.setCustomValidity('Passwords do not match');
                } else {
                    this.style.borderColor = '#00FFB3';
                    this.setCustomValidity('');
                }
            });
        }

        // Mobile number validation (only numbers)
        const mobileInput = document.getElementById('mobile_no');
        if (mobileInput) {
            mobileInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value.length > 10) {
                    this.value = this.value.slice(0, 10);
                }
                
                // Reset OTP verification if mobile number changes
                const verifiedMobile = sessionStorage.getItem('verified_mobile');
                if (verifiedMobile && verifiedMobile !== '+91' + this.value) {
                    resetOTPVerification();
                }
            });
        }

        // Username validation
        const usernameInput = document.getElementById('username');
        if (usernameInput) {
            usernameInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^a-zA-Z0-9_]/g, '');
            });
        }

        // Real-time email validation with Gmail check
        const emailInput = document.getElementById('email');
        if (emailInput) {
            emailInput.addEventListener('blur', function() {
                if (this.value) {
                    const emailValidation = validateEmailEnhanced(this.value);
                    if (!emailValidation.isValid) {
                        this.style.borderColor = '#FF004C';
                        showError(emailValidation.error);
                    } else if (!validateEmail(this.value)) {
                        this.style.borderColor = '#FF004C';
                        showError('Please enter a valid email address');
                    } else {
                        this.style.borderColor = '#00FFB3';
                    }
                }
            });
            
            // Real-time Gmail validation
            emailInput.addEventListener('input', function() {
                if (this.value && !this.value.endsWith('@gmail.com')) {
                    this.style.borderColor = '#FF8A00';
                } else if (this.value) {
                    this.style.borderColor = '#00FFB3';
                }
            });
        }

        // OTP input validation
        const otpInput = document.getElementById('otp');
        if (otpInput) {
            otpInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value.length > 6) {
                    this.value = this.value.slice(0, 6);
                }
            });
        }

        // Form submission handler
        signupForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = {
                username: sanitizeInput(document.getElementById('username').value),
                full_name: sanitizeInput(document.getElementById('full_name').value),
                email: sanitizeInput(document.getElementById('email').value).toLowerCase(),
                mobile_no: '+91' + document.getElementById('mobile_no').value,
                password: document.getElementById('password').value,
                confirm_password: document.getElementById('confirm_password').value,
                csrf_token: csrfTokenInput.value
            };

            // Validate form data
            const validation = validateFormData(formData);
            if (!validation.isValid) {
                showError(validation.error);
                if (validation.field) {
                    document.getElementById(validation.field).focus();
                }
                return;
            }

            // Update UI for loading state
            signupBtn.disabled = true;
            signupBtn.innerHTML = '<span class="btn-text">Creating Secure Account...</span>';
            
            // Add loading animation to button
            signupBtn.classList.add('loading');

            try {
                const response = await fetch(`${API_BASE_URL}/api/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfTokenInput.value
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess(data.message || 'Account created successfully!');
                    
                    // Clear verification status
                    sessionStorage.removeItem('mobile_verified');
                    sessionStorage.removeItem('verified_mobile');
                    sessionStorage.removeItem('social_verification');
                    
                    // Log successful signup attempt
                    console.log('User registration successful:', formData.username);
                    
                    // Redirect to login page after delay
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    // Handle specific error messages
                    let errorMessage = data.error || 'Registration failed';
                    
                    // Provide specific guidance based on error type
                    if (errorMessage.includes('username') || errorMessage.includes('Username')) {
                        errorMessage += ' Please choose a different username.';
                        document.getElementById('username').focus();
                    } else if (errorMessage.includes('email') || errorMessage.includes('Email')) {
                        errorMessage += ' Please use a different Gmail or try logging in.';
                        document.getElementById('email').focus();
                    } else if (errorMessage.includes('password')) {
                        document.getElementById('password').focus();
                    } else if (errorMessage.includes('mobile')) {
                        document.getElementById('mobile_no').focus();
                    }
                    
                    showError(errorMessage);
                    
                    // Log failed signup attempt
                    console.warn('User registration failed:', errorMessage);
                }
            } catch (error) {
                console.error('Signup network error:', error);
                showError('Network error. Please check your internet connection and try again.');
            } finally {
                // Reset UI state
                signupBtn.disabled = false;
                signupBtn.innerHTML = '<span class="btn-text">Create Secure Account</span>';
                signupBtn.classList.remove('loading');
            }
        });

        // Auto-advance to next field on Enter key
        const inputs = document.querySelectorAll('input');
        inputs.forEach((input, index) => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    } else {
                        // If last input, submit form
                        signupForm.dispatchEvent(new Event('submit'));
                    }
                }
            });
        });

        // Input focus effects
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.classList.remove('focused');
            });
        });

        // Auto-focus on first input
        document.getElementById('username').focus();

        // Add security logging
        console.log('Secure signup page initialized:', new Date().toISOString());
    });

    // Additional security features
    window.addEventListener('beforeunload', function() {
        // Clear sensitive data from memory
        const passwordInputs = document.querySelectorAll('input[type="password"]');
        passwordInputs.forEach(input => {
            input.value = '';
        });
    });

    // Prevent form resubmission on page refresh
    if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }



    async function testMSG91Config() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/check-msg91-status`);
        const data = await response.json();
        alert(`MSG91 Status:\nConfigured: ${data.msg91_configured}\nAuth Key: ${data.auth_key_exists}\nTemplate ID: ${data.template_id_exists}`);
        console.log('MSG91 Config:', data);
    } catch (error) {
        alert('Error testing MSG91 config: ' + error.message);
    }
}



async function debugMSG91Config() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/debug-msg91`);
        const data = await response.json();
        
        let message = `MSG91 Configuration Debug:\n\n`;
        message += `Auth Key Set: ${data.msg91_auth_key_set ? '‚úÖ' : '‚ùå'}\n`;
        message += `Template ID Set: ${data.msg91_template_id_set ? '‚úÖ' : '‚ùå'}\n`;
        message += `Sender ID Set: ${data.msg91_sender_id_set ? '‚úÖ' : '‚ùå'}\n`;
        message += `API Test Status: ${data.api_test_status}\n`;
        message += `Auth Key Length: ${data.auth_key_length}\n`;
        message += `Template ID: ${data.template_id}\n`;
        message += `Sender ID: ${data.sender_id}`;
        
        alert(message);
        console.log('MSG91 Debug Details:', data);
    } catch (error) {
        alert('Error debugging MSG91: ' + error.message);
    }
}

async function forceSendOTP() {
    const mobileNo = document.getElementById('mobile_no').value;
    if (!mobileNo || mobileNo.length !== 10) {
        alert('Please enter a valid 10-digit mobile number first');
        return;
    }

    const sendOtpBtn = document.getElementById('send-otp-btn');
    const otpStatus = document.getElementById('otp-status');

    sendOtpBtn.disabled = true;
    sendOtpBtn.textContent = 'Sending...';
    otpStatus.innerHTML = '<span style="color: #2EC6FF">Force sending OTP...</span>';

    try {
        const response = await fetch(`${API_BASE_URL}/api/send-otp`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mobile_no: '+91' + mobileNo
            })
        });

        const data = await response.json();
        console.log('Force OTP Response:', data);

        if (response.ok) {
            document.getElementById('otp').style.display = 'block';
            document.getElementById('verify-otp-btn').style.display = 'block';
            startOTPTimer();
            
            if (data.otp) {
                otpStatus.innerHTML = `<span style="color: #FF8A00">üì± OTP for testing: <strong>${data.otp}</strong></span>`;
                alert(`OTP Generated: ${data.otp}\n\nSMS delivery failed, but you can use this OTP to test.`);
            } else {
                otpStatus.innerHTML = '<span style="color: #00FFB3">‚úÖ OTP sent via SMS!</span>';
            }
        } else {
            alert('Failed to send OTP: ' + (data.error || 'Unknown error'));
            otpStatus.innerHTML = '<span style="color: #FF004C">Failed to send OTP</span>';
        }
    } catch (error) {
        alert('Network error: ' + error.message);
        otpStatus.innerHTML = '<span style="color: #FF004C">Network error</span>';
    } finally {
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Send OTP';
    }
}

async function checkServerLogs() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/debug-env`);
        const data = await response.json();
        
        alert(`Server Environment:\n\n` +
              `Database: ${data.DATABASE_URL}\n` +
              `Email: ${data.EMAIL_USER}\n` +
              `All services should be running on Render`);
    } catch (error) {
        alert('Cannot reach server: ' + error.message);
    }
}
</script>
</body>
</html>






